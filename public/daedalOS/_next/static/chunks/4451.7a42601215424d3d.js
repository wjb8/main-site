"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4451],{34451:(e,t,r)=>{r.d(t,{HG:()=>Q,QM:()=>V,Xt:()=>B,iR:()=>x,nS:()=>G,od:()=>j,r6:()=>U,rn:()=>R,tv:()=>L,wz:()=>u,zV:()=>N});var i=r(36129),s=Object.defineProperty;function n(...e){}((e,t)=>{for(var r in t)s(e,r,{get:t[r],enumerable:!0})})({},{QuickJSAsyncifyError:()=>h,QuickJSAsyncifySuspended:()=>c,QuickJSEmptyGetOwnPropertyNames:()=>v,QuickJSEmscriptenModuleError:()=>m,QuickJSMemoryLeakDetected:()=>d,QuickJSNotImplemented:()=>u,QuickJSPromisePending:()=>p,QuickJSUnknownIntrinsic:()=>f,QuickJSUnwrapError:()=>o,QuickJSUseAfterFree:()=>l,QuickJSWrongOwner:()=>a});var o=class extends Error{constructor(e,t){super("object"==typeof e&&e&&"message"in e?String(e.message):String(e)),this.cause=e,this.context=t,this.name="QuickJSUnwrapError"}},a=class extends Error{constructor(){super(...arguments),this.name="QuickJSWrongOwner"}},l=class extends Error{constructor(){super(...arguments),this.name="QuickJSUseAfterFree"}},u=class extends Error{constructor(){super(...arguments),this.name="QuickJSNotImplemented"}},h=class extends Error{constructor(){super(...arguments),this.name="QuickJSAsyncifyError"}},c=class extends Error{constructor(){super(...arguments),this.name="QuickJSAsyncifySuspended"}},d=class extends Error{constructor(){super(...arguments),this.name="QuickJSMemoryLeakDetected"}},m=class extends Error{constructor(){super(...arguments),this.name="QuickJSEmscriptenModuleError"}},f=class extends TypeError{constructor(){super(...arguments),this.name="QuickJSUnknownIntrinsic"}},p=class extends Error{constructor(){super(...arguments),this.name="QuickJSPromisePending"}},v=class extends Error{constructor(){super(...arguments),this.name="QuickJSEmptyGetOwnPropertyNames"}};function*y(e){return yield e}function w(e,t){return(...r)=>S(t.call(e,y,...r))}function S(e){return function t(r){return r.done?r.value:r.value instanceof Promise?r.value.then(r=>t(e.next(r)),r=>t(e.throw(r))):t(e.next(r.value))}(e.next())}y.of=function(e){return y(S(e))};var g=class{[Symbol.dispose](){return this.dispose()}},b=Symbol.dispose??Symbol.for("Symbol.dispose"),_=g.prototype;_[b]||(_[b]=function(){return this.dispose()});var x=class e extends g{constructor(e,t,r,i){super(),this._value=e,this.copier=t,this.disposer=r,this._owner=i,this._alive=!0,this._constructorStack=void 0}get alive(){return this._alive}get value(){return this.assertAlive(),this._value}get owner(){return this._owner}get dupable(){return!!this.copier}dup(){if(this.assertAlive(),!this.copier)throw Error("Non-dupable lifetime");return new e(this.copier(this._value),this.copier,this.disposer,this._owner)}consume(e){this.assertAlive();let t=e(this);return this.dispose(),t}map(e){return this.assertAlive(),e(this)}tap(e){return e(this),this}dispose(){this.assertAlive(),this.disposer&&this.disposer(this._value),this._alive=!1}assertAlive(){if(!this.alive)throw new l(this._constructorStack?`Lifetime not alive
${this._constructorStack}
Lifetime used`:"Lifetime not alive")}},P=class extends x{constructor(e,t){super(e,void 0,void 0,t)}get dupable(){return!0}dup(){return this}dispose(){}},T=class extends x{constructor(e,t,r,i){super(e,t,r,i)}dispose(){this._alive=!1}};function E(e,t){let r;try{e.dispose()}catch(e){r=e}if(t&&r)throw Object.assign(t,{message:`${t.message}
 Then, failed to dispose scope: ${r.message}`,disposeError:r}),t;if(t||r)throw t||r}var Q=class e extends g{constructor(){super(...arguments),this._disposables=new x(new Set),this.manage=e=>(this._disposables.value.add(e),e)}static withScope(t){let r=new e,i;try{return t(r)}catch(e){throw i=e,e}finally{E(r,i)}}static withScopeMaybeAsync(t,r){return S((function*(i){let s=new e,n;try{return yield*i.of(r.call(t,i,s))}catch(e){throw n=e,e}finally{E(s,n)}}).call(void 0,y))}static async withScopeAsync(t){let r=new e,i;try{return await t(r)}catch(e){throw i=e,e}finally{E(r,i)}}get alive(){return this._disposables.alive}dispose(){for(let e of Array.from(this._disposables.value.values()).reverse())e.alive&&e.dispose();this._disposables.dispose()}};function A(e){return!!(e&&("object"==typeof e||"function"==typeof e)&&"alive"in e&&"boolean"==typeof e.alive&&"dispose"in e&&"function"==typeof e.dispose)}var k=class e extends g{static success(e){return new M(e)}static fail(e,t){return new H(e,t)}static is(t){return t instanceof e}},M=class extends k{constructor(e){super(),this.value=e}get alive(){return!A(this.value)||this.value.alive}dispose(){A(this.value)&&this.value.dispose()}unwrap(){return this.value}unwrapOr(e){return this.value}},H=class extends k{constructor(e,t){super(),this.error=e,this.onUnwrap=t}get alive(){return!A(this.error)||this.error.alive}dispose(){A(this.error)&&this.error.dispose()}unwrap(){throw this.onUnwrap(this),this.error}unwrapOr(e){return e}},C=class extends g{constructor(e){super(),this.resolve=e=>{this.resolveHandle.alive&&(this.context.unwrapResult(this.context.callFunction(this.resolveHandle,this.context.undefined,e||this.context.undefined)).dispose(),this.disposeResolvers(),this.onSettled())},this.reject=e=>{this.rejectHandle.alive&&(this.context.unwrapResult(this.context.callFunction(this.rejectHandle,this.context.undefined,e||this.context.undefined)).dispose(),this.disposeResolvers(),this.onSettled())},this.dispose=()=>{this.handle.alive&&this.handle.dispose(),this.disposeResolvers()},this.context=e.context,this.owner=e.context.runtime,this.handle=e.promiseHandle,this.settled=new Promise(e=>{this.onSettled=e}),this.resolveHandle=e.resolveHandle,this.rejectHandle=e.rejectHandle}get alive(){return this.handle.alive||this.resolveHandle.alive||this.rejectHandle.alive}disposeResolvers(){this.resolveHandle.alive&&this.resolveHandle.dispose(),this.rejectHandle.alive&&this.rejectHandle.dispose()}},J=class{constructor(e){this.module=e}toPointerArray(e){let t=new Int32Array(e.map(e=>e.value)),r=t.length*t.BYTES_PER_ELEMENT,i=this.module._malloc(r);return new Uint8Array(this.module.HEAPU8.buffer,i,r).set(new Uint8Array(t.buffer)),new x(i,void 0,e=>this.module._free(e))}newTypedArray(e,t){let r=new e(Array(t).fill(0)),i=r.length*r.BYTES_PER_ELEMENT,s=this.module._malloc(i),n=new e(this.module.HEAPU8.buffer,s,t);return n.set(r),new x({typedArray:n,ptr:s},void 0,e=>this.module._free(e.ptr))}newMutablePointerArray(e){return this.newTypedArray(Int32Array,e)}newHeapCharPointer(e){let t=this.module.lengthBytesUTF8(e),r=t+1,i=this.module._malloc(r);return this.module.stringToUTF8(e,i,r),new x({ptr:i,strlen:t},void 0,e=>this.module._free(e.ptr))}newHeapBufferPointer(e){let t=e.byteLength,r=this.module._malloc(t);return this.module.HEAPU8.set(e,r),new x({pointer:r,numBytes:t},void 0,e=>this.module._free(e.pointer))}consumeHeapCharPointer(e){let t=this.module.UTF8ToString(e);return this.module._free(e),t}};function L(e){if(!e)return 0;let t=0;for(let[r,s]of Object.entries(e)){if(!(r in i.qG))throw new f(r);s&&(t|=i.qG[r])}return t}function N(e){if("number"==typeof e)return e;if(void 0===e)return 0;let{type:t,strict:r,strip:s,compileOnly:n,backtraceBarrier:o}=e,a=0;return"global"===t&&(a|=i.WB.JS_EVAL_TYPE_GLOBAL),"module"===t&&(a|=i.WB.JS_EVAL_TYPE_MODULE),r&&(a|=i.WB.JS_EVAL_FLAG_STRICT),s&&(a|=i.WB.JS_EVAL_FLAG_STRIP),n&&(a|=i.WB.JS_EVAL_FLAG_COMPILE_ONLY),o&&(a|=i.WB.JS_EVAL_FLAG_BACKTRACE_BARRIER),a}Symbol("Unstable"),Object.freeze({BaseObjects:!0,Date:!0,Eval:!0,StringNormalize:!0,RegExp:!0,JSON:!0,Proxy:!0,MapSet:!0,TypedArrays:!0,Promise:!0});var O=class extends g{constructor(e,t){super(),this.handle=e,this.context=t,this._isDone=!1,this.owner=t.runtime}[Symbol.iterator](){return this}next(e){if(!this.alive||this._isDone)return{done:!0,value:void 0};let t=this._next??(this._next=this.context.getProp(this.handle,"next"));return this.callIteratorMethod(t,e)}return(e){if(!this.alive)return{done:!0,value:void 0};let t=this.context.getProp(this.handle,"return");if(t===this.context.undefined&&void 0===e)return this.dispose(),{done:!0,value:void 0};let r=this.callIteratorMethod(t,e);return t.dispose(),this.dispose(),r}throw(e){if(!this.alive)return{done:!0,value:void 0};let t=e instanceof x?e:this.context.newError(e),r=this.context.getProp(this.handle,"throw"),i=this.callIteratorMethod(r,e);return t.alive&&t.dispose(),r.dispose(),this.dispose(),i}get alive(){return this.handle.alive}dispose(){this._isDone=!0,this.handle.dispose(),this._next?.dispose()}callIteratorMethod(e,t){let r=t?this.context.callFunction(e,this.handle,t):this.context.callFunction(e,this.handle);if(r.error)return this.dispose(),{value:r};let i=this.context.getProp(r.value,"done").consume(e=>this.context.dump(e));if(i)return r.value.dispose(),this.dispose(),{done:i,value:void 0};let s=this.context.getProp(r.value,"value");return r.value.dispose(),{value:k.success(s),done:i}}},I=class extends J{constructor(e){super(e.module),this.scope=new Q,this.copyJSValue=e=>this.ffi.QTS_DupValuePointer(this.ctx.value,e),this.freeJSValue=e=>{this.ffi.QTS_FreeValuePointer(this.ctx.value,e)},e.ownedLifetimes?.forEach(e=>this.scope.manage(e)),this.owner=e.owner,this.module=e.module,this.ffi=e.ffi,this.rt=e.rt,this.ctx=this.scope.manage(e.ctx)}get alive(){return this.scope.alive}dispose(){return this.scope.dispose()}[Symbol.dispose](){return this.dispose()}manage(e){return this.scope.manage(e)}consumeJSCharPointer(e){let t=this.module.UTF8ToString(e);return this.ffi.QTS_FreeCString(this.ctx.value,e),t}heapValueHandle(e){return new x(e,this.copyJSValue,this.freeJSValue,this.owner)}staticHeapValueHandle(e){return this.manage(this.heapValueHandle(e)),new P(e,this.owner)}},V=class extends g{constructor(e){super(),this._undefined=void 0,this._null=void 0,this._false=void 0,this._true=void 0,this._global=void 0,this._BigInt=void 0,this._Symbol=void 0,this._SymbolIterator=void 0,this._SymbolAsyncIterator=void 0,this.fnNextId=-32768,this.fnMaps=new Map,this.cToHostCallbacks={callFunction:(e,t,r,i,s)=>{if(e!==this.ctx.value)throw Error("QuickJSContext instance received C -> JS call with mismatched ctx");let n=this.getFunction(s);if(!n)throw Error(`QuickJSContext had no callback with id ${s}`);return Q.withScopeMaybeAsync(this,function*(e,s){let o=s.manage(new T(t,this.memory.copyJSValue,this.memory.freeJSValue,this.runtime)),a=Array(r);for(let e=0;e<r;e++){let t=this.ffi.QTS_ArgvGetJSValueConstPointer(i,e);a[e]=s.manage(new T(t,this.memory.copyJSValue,this.memory.freeJSValue,this.runtime))}try{let t=yield*e(n.apply(o,a));if(t){if("error"in t&&t.error)throw this.runtime.debugLog("throw error",t.error),t.error;let e=s.manage(t instanceof x?t:t.value);return this.ffi.QTS_DupValuePointer(this.ctx.value,e.value)}return 0}catch(e){return this.errorToHandle(e).consume(e=>this.ffi.QTS_Throw(this.ctx.value,e.value))}})}},this.runtime=e.runtime,this.module=e.module,this.ffi=e.ffi,this.rt=e.rt,this.ctx=e.ctx,this.memory=new I({...e,owner:this.runtime}),e.callbacks.setContextCallbacks(this.ctx.value,this.cToHostCallbacks),this.dump=this.dump.bind(this),this.getString=this.getString.bind(this),this.getNumber=this.getNumber.bind(this),this.resolvePromise=this.resolvePromise.bind(this),this.uint32Out=this.memory.manage(this.memory.newTypedArray(Uint32Array,1))}get alive(){return this.memory.alive}dispose(){this.memory.dispose()}get undefined(){if(this._undefined)return this._undefined;let e=this.ffi.QTS_GetUndefined();return this._undefined=new P(e)}get null(){if(this._null)return this._null;let e=this.ffi.QTS_GetNull();return this._null=new P(e)}get true(){if(this._true)return this._true;let e=this.ffi.QTS_GetTrue();return this._true=new P(e)}get false(){if(this._false)return this._false;let e=this.ffi.QTS_GetFalse();return this._false=new P(e)}get global(){if(this._global)return this._global;let e=this.ffi.QTS_GetGlobalObject(this.ctx.value);return this._global=this.memory.staticHeapValueHandle(e),this._global}newNumber(e){return this.memory.heapValueHandle(this.ffi.QTS_NewFloat64(this.ctx.value,e))}newString(e){let t=this.memory.newHeapCharPointer(e).consume(e=>this.ffi.QTS_NewString(this.ctx.value,e.value.ptr));return this.memory.heapValueHandle(t)}newUniqueSymbol(e){let t=("symbol"==typeof e?e.description:e)??"",r=this.memory.newHeapCharPointer(t).consume(e=>this.ffi.QTS_NewSymbol(this.ctx.value,e.value.ptr,0));return this.memory.heapValueHandle(r)}newSymbolFor(e){let t=("symbol"==typeof e?e.description:e)??"",r=this.memory.newHeapCharPointer(t).consume(e=>this.ffi.QTS_NewSymbol(this.ctx.value,e.value.ptr,1));return this.memory.heapValueHandle(r)}getWellKnownSymbol(e){return this._Symbol??(this._Symbol=this.memory.manage(this.getProp(this.global,"Symbol"))),this.getProp(this._Symbol,e)}newBigInt(e){if(!this._BigInt){let e=this.getProp(this.global,"BigInt");this.memory.manage(e),this._BigInt=new P(e.value,this.runtime)}let t=this._BigInt,r=String(e);return this.newString(r).consume(e=>this.unwrapResult(this.callFunction(t,this.undefined,e)))}newObject(e){e&&this.runtime.assertOwned(e);let t=e?this.ffi.QTS_NewObjectProto(this.ctx.value,e.value):this.ffi.QTS_NewObject(this.ctx.value);return this.memory.heapValueHandle(t)}newArray(){let e=this.ffi.QTS_NewArray(this.ctx.value);return this.memory.heapValueHandle(e)}newArrayBuffer(e){let t=new Uint8Array(e),r=this.memory.newHeapBufferPointer(t),i=this.ffi.QTS_NewArrayBuffer(this.ctx.value,r.value.pointer,t.length);return this.memory.heapValueHandle(i)}newPromise(e){let t=Q.withScope(e=>{let t=e.manage(this.memory.newMutablePointerArray(2)),r=this.ffi.QTS_NewPromiseCapability(this.ctx.value,t.value.ptr),i=this.memory.heapValueHandle(r),[s,n]=Array.from(t.value.typedArray).map(e=>this.memory.heapValueHandle(e));return new C({context:this,promiseHandle:i,resolveHandle:s,rejectHandle:n})});return e&&"function"==typeof e&&(e=new Promise(e)),e&&Promise.resolve(e).then(t.resolve,e=>e instanceof x?t.reject(e):this.newError(e).consume(t.reject)),t}newFunction(e,t){let r=++this.fnNextId;return this.setFunction(r,t),this.memory.heapValueHandle(this.ffi.QTS_NewFunction(this.ctx.value,r,e))}newError(e){let t=this.memory.heapValueHandle(this.ffi.QTS_NewError(this.ctx.value));return e&&"object"==typeof e?(void 0!==e.name&&this.newString(e.name).consume(e=>this.setProp(t,"name",e)),void 0!==e.message&&this.newString(e.message).consume(e=>this.setProp(t,"message",e))):"string"==typeof e?this.newString(e).consume(e=>this.setProp(t,"message",e)):void 0!==e&&this.newString(String(e)).consume(e=>this.setProp(t,"message",e)),t}typeof(e){return this.runtime.assertOwned(e),this.memory.consumeHeapCharPointer(this.ffi.QTS_Typeof(this.ctx.value,e.value))}getNumber(e){return this.runtime.assertOwned(e),this.ffi.QTS_GetFloat64(this.ctx.value,e.value)}getString(e){return this.runtime.assertOwned(e),this.memory.consumeJSCharPointer(this.ffi.QTS_GetString(this.ctx.value,e.value))}getSymbol(e){this.runtime.assertOwned(e);let t=this.memory.consumeJSCharPointer(this.ffi.QTS_GetSymbolDescriptionOrKey(this.ctx.value,e.value));return this.ffi.QTS_IsGlobalSymbol(this.ctx.value,e.value)?Symbol.for(t):Symbol(t)}getBigInt(e){return this.runtime.assertOwned(e),BigInt(this.getString(e))}getArrayBuffer(e){this.runtime.assertOwned(e);let t=this.ffi.QTS_GetArrayBufferLength(this.ctx.value,e.value),r=this.ffi.QTS_GetArrayBuffer(this.ctx.value,e.value);if(!r)throw Error("Couldn't allocate memory to get ArrayBuffer");return new x(this.module.HEAPU8.subarray(r,r+t),void 0,()=>this.module._free(r))}getPromiseState(e){this.runtime.assertOwned(e);let t=this.ffi.QTS_PromiseState(this.ctx.value,e.value);if(t<0)return{type:"fulfilled",value:e,notAPromise:!0};if(t===i.zd.Pending)return{type:"pending",get error(){return new p("Cannot unwrap a pending promise")}};let r=this.ffi.QTS_PromiseResult(this.ctx.value,e.value),s=this.memory.heapValueHandle(r);if(t===i.zd.Fulfilled)return{type:"fulfilled",value:s};if(t===i.zd.Rejected)return{type:"rejected",error:s};throw s.dispose(),Error(`Unknown JSPromiseStateEnum: ${t}`)}resolvePromise(e){this.runtime.assertOwned(e);let t=Q.withScope(t=>{let r=t.manage(this.getProp(this.global,"Promise")),i=t.manage(this.getProp(r,"resolve"));return this.callFunction(i,r,e)});return t.error?Promise.resolve(t):new Promise(e=>{Q.withScope(r=>{let i=r.manage(this.newFunction("resolve",t=>{e(this.success(t&&t.dup()))})),s=r.manage(this.newFunction("reject",t=>{e(this.fail(t&&t.dup()))})),n=r.manage(t.value),o=r.manage(this.getProp(n,"then"));this.callFunction(o,n,i,s).unwrap().dispose()})})}isEqual(e,t,r=i.es.IsStrictlyEqual){if(e===t)return!0;this.runtime.assertOwned(e),this.runtime.assertOwned(t);let s=this.ffi.QTS_IsEqual(this.ctx.value,e.value,t.value,r);if(-1===s)throw new u("WASM variant does not expose equality");return!!s}eq(e,t){return this.isEqual(e,t,i.es.IsStrictlyEqual)}sameValue(e,t){return this.isEqual(e,t,i.es.IsSameValue)}sameValueZero(e,t){return this.isEqual(e,t,i.es.IsSameValueZero)}getProp(e,t){let r;return this.runtime.assertOwned(e),r="number"==typeof t&&t>=0?this.ffi.QTS_GetPropNumber(this.ctx.value,e.value,t):this.borrowPropertyKey(t).consume(t=>this.ffi.QTS_GetProp(this.ctx.value,e.value,t.value)),this.memory.heapValueHandle(r)}getLength(e){if(this.runtime.assertOwned(e),!(0>this.ffi.QTS_GetLength(this.ctx.value,this.uint32Out.value.ptr,e.value)))return this.uint32Out.value.typedArray[0]}getOwnPropertyNames(e,t={strings:!0,numbersAsStrings:!0}){this.runtime.assertOwned(e),e.value;let r=function(e){if("number"==typeof e)return e;if(void 0===e)return 0;let{strings:t,symbols:r,quickjsPrivate:s,onlyEnumerable:n,numbers:o,numbersAsStrings:a}=e,l=0;return t&&(l|=i.h1.JS_GPN_STRING_MASK),r&&(l|=i.h1.JS_GPN_SYMBOL_MASK),s&&(l|=i.h1.JS_GPN_PRIVATE_MASK),n&&(l|=i.h1.JS_GPN_ENUM_ONLY),o&&(l|=i.h1.QTS_GPN_NUMBER_MASK),a&&(l|=i.h1.QTS_STANDARD_COMPLIANT_NUMBER),l}(t);if(0===r)throw new v("No options set, will return an empty array");return Q.withScope(t=>{let i=t.manage(this.memory.newMutablePointerArray(1)),s=this.ffi.QTS_GetOwnPropertyNames(this.ctx.value,i.value.ptr,this.uint32Out.value.ptr,e.value,r);if(s)return this.fail(this.memory.heapValueHandle(s));let n=this.uint32Out.value.typedArray[0],o=i.value.typedArray[0],a=Array.from(new Uint32Array(this.module.HEAP8.buffer,o,n)).map(e=>this.memory.heapValueHandle(e));return this.ffi.QTS_FreeVoidPointer(this.ctx.value,o),this.success(function(e){let t=e?Array.from(e):[];function r(){return t.forEach(e=>e.alive?e.dispose():void 0)}return Object.defineProperty(t,b,{configurable:!0,enumerable:!1,value:r}),Object.defineProperty(t,"dispose",{configurable:!0,enumerable:!1,value:r}),Object.defineProperty(t,"alive",{configurable:!0,enumerable:!1,get:function(){return t.some(e=>e.alive)}}),t}(a))})}getIterator(e){let t=this._SymbolIterator??(this._SymbolIterator=this.memory.manage(this.getWellKnownSymbol("iterator")));return Q.withScope(r=>{let i=r.manage(this.getProp(e,t)),s=this.callFunction(i,e);return s.error?s:this.success(new O(s.value,this))})}setProp(e,t,r){this.runtime.assertOwned(e),this.borrowPropertyKey(t).consume(t=>this.ffi.QTS_SetProp(this.ctx.value,e.value,t.value,r.value))}defineProp(e,t,r){this.runtime.assertOwned(e),Q.withScope(i=>{let s=i.manage(this.borrowPropertyKey(t)),n=r.value||this.undefined,o=!!r.configurable,a=!!r.enumerable,l=!!r.value,u=r.get?i.manage(this.newFunction(r.get.name,r.get)):this.undefined,h=r.set?i.manage(this.newFunction(r.set.name,r.set)):this.undefined;this.ffi.QTS_DefineProp(this.ctx.value,e.value,s.value,n.value,u.value,h.value,o,a,l)})}callFunction(e,t,...r){this.runtime.assertOwned(e);let i,s=r[0];i=void 0===s||Array.isArray(s)?s??[]:r;let n=this.memory.toPointerArray(i).consume(r=>this.ffi.QTS_Call(this.ctx.value,e.value,t.value,i.length,r.value)),o=this.ffi.QTS_ResolveException(this.ctx.value,n);return o?(this.ffi.QTS_FreeValuePointer(this.ctx.value,n),this.fail(this.memory.heapValueHandle(o))):this.success(this.memory.heapValueHandle(n))}callMethod(e,t,r=[]){return this.getProp(e,t).consume(t=>this.callFunction(t,e,r))}evalCode(e,t="eval.js",r){let i=+(void 0===r),s=N(r),n=this.memory.newHeapCharPointer(e).consume(e=>this.ffi.QTS_Eval(this.ctx.value,e.value.ptr,e.value.strlen,t,i,s)),o=this.ffi.QTS_ResolveException(this.ctx.value,n);return o?(this.ffi.QTS_FreeValuePointer(this.ctx.value,n),this.fail(this.memory.heapValueHandle(o))):this.success(this.memory.heapValueHandle(n))}throw(e){return this.errorToHandle(e).consume(e=>this.ffi.QTS_Throw(this.ctx.value,e.value))}borrowPropertyKey(e){return"number"==typeof e?this.newNumber(e):"string"==typeof e?this.newString(e):new P(e.value,this.runtime)}getMemory(e){if(e===this.rt.value)return this.memory;throw Error("Private API. Cannot get memory from a different runtime")}dump(e){this.runtime.assertOwned(e);let t=this.typeof(e);if("string"===t)return this.getString(e);if("number"===t)return this.getNumber(e);if("bigint"===t)return this.getBigInt(e);if("undefined"===t)return;if("symbol"===t)return this.getSymbol(e);let r=this.getPromiseState(e);if("fulfilled"===r.type&&!r.notAPromise)return e.dispose(),{type:r.type,value:r.value.consume(this.dump)};if("pending"===r.type)return e.dispose(),{type:r.type};if("rejected"===r.type)return e.dispose(),{type:r.type,error:r.error.consume(this.dump)};let i=this.memory.consumeJSCharPointer(this.ffi.QTS_Dump(this.ctx.value,e.value));try{return JSON.parse(i)}catch{return i}}unwrapResult(e){if(e.error){let t="context"in e.error?e.error.context:this,r=e.error.consume(e=>this.dump(e));if(r&&"object"==typeof r&&"string"==typeof r.message){let{message:e,name:i,stack:s,...n}=r,a=new o(r,t);"string"==typeof i&&(a.name=r.name),a.message=e;let l=a.stack;throw"string"==typeof s&&(a.stack=`${i}: ${e}
${r.stack}Host: ${l}`),Object.assign(a,n),a}throw new o(r)}return e.value}[Symbol.for("nodejs.util.inspect.custom")](){return this.alive?`${this.constructor.name} { ctx: ${this.ctx.value} rt: ${this.rt.value} }`:`${this.constructor.name} { disposed }`}getFunction(e){let t=this.fnMaps.get(e>>8);if(t)return t.get(e)}setFunction(e,t){let r=e>>8,i=this.fnMaps.get(r);return i||(i=new Map,this.fnMaps.set(r,i)),i.set(e,t)}errorToHandle(e){return e instanceof x?e:this.newError(e)}encodeBinaryJSON(e){let t=this.ffi.QTS_bjson_encode(this.ctx.value,e.value);return this.memory.heapValueHandle(t)}decodeBinaryJSON(e){let t=this.ffi.QTS_bjson_decode(this.ctx.value,e.value);return this.memory.heapValueHandle(t)}success(e){return k.success(e)}fail(e){return k.fail(e,e=>this.unwrapResult(e))}},R=class extends g{constructor(e){super(),this.scope=new Q,this.contextMap=new Map,this._debugMode=!1,this.cToHostCallbacks={shouldInterrupt:e=>{if(e!==this.rt.value)throw Error("QuickJSContext instance received C -> JS interrupt with mismatched rt");let t=this.interruptHandler;if(!t)throw Error("QuickJSContext had no interrupt handler");return+!!t(this)},loadModuleSource:w(this,function*(e,t,r,i){let s=this.moduleLoader;if(!s)throw Error("Runtime has no module loader");if(t!==this.rt.value)throw Error("Runtime pointer mismatch");let n=this.contextMap.get(r)??this.newContext({contextPointer:r});try{let t=yield*e(s(i,n));if("object"==typeof t&&"error"in t&&t.error)throw this.debugLog("cToHostLoadModule: loader returned error",t.error),t.error;let r="string"==typeof t?t:"value"in t?t.value:t;return this.memory.newHeapCharPointer(r).value.ptr}catch(e){return this.debugLog("cToHostLoadModule: caught error",e),n.throw(e),0}}),normalizeModule:w(this,function*(e,t,r,i,s){let n=this.moduleNormalizer;if(!n)throw Error("Runtime has no module normalizer");if(t!==this.rt.value)throw Error("Runtime pointer mismatch");let o=this.contextMap.get(r)??this.newContext({contextPointer:r});try{let t=yield*e(n(i,s,o));if("object"==typeof t&&"error"in t&&t.error)throw this.debugLog("cToHostNormalizeModule: normalizer returned error",t.error),t.error;let r="string"==typeof t?t:t.value;return o.getMemory(this.rt.value).newHeapCharPointer(r).value.ptr}catch(e){return this.debugLog("normalizeModule: caught error",e),o.throw(e),0}})},e.ownedLifetimes?.forEach(e=>this.scope.manage(e)),this.module=e.module,this.memory=new J(this.module),this.ffi=e.ffi,this.rt=e.rt,this.callbacks=e.callbacks,this.scope.manage(this.rt),this.callbacks.setRuntimeCallbacks(this.rt.value,this.cToHostCallbacks),this.executePendingJobs=this.executePendingJobs.bind(this)}get alive(){return this.scope.alive}dispose(){return this.scope.dispose()}newContext(e={}){let t=L(e.intrinsics),r=new x(e.contextPointer||this.ffi.QTS_NewContext(this.rt.value,t),void 0,e=>{this.contextMap.delete(e),this.callbacks.deleteContext(e),this.ffi.QTS_FreeContext(e)}),i=new V({module:this.module,ctx:r,ffi:this.ffi,rt:this.rt,ownedLifetimes:e.ownedLifetimes,runtime:this,callbacks:this.callbacks});return this.contextMap.set(r.value,i),i}setModuleLoader(e,t){this.moduleLoader=e,this.moduleNormalizer=t,this.ffi.QTS_RuntimeEnableModuleLoader(this.rt.value,+!!this.moduleNormalizer)}removeModuleLoader(){this.moduleLoader=void 0,this.ffi.QTS_RuntimeDisableModuleLoader(this.rt.value)}hasPendingJob(){return!!this.ffi.QTS_IsJobPending(this.rt.value)}setInterruptHandler(e){let t=this.interruptHandler;this.interruptHandler=e,t||this.ffi.QTS_RuntimeEnableInterruptHandler(this.rt.value)}removeInterruptHandler(){this.interruptHandler&&(this.ffi.QTS_RuntimeDisableInterruptHandler(this.rt.value),this.interruptHandler=void 0)}executePendingJobs(e=-1){let t=this.memory.newMutablePointerArray(1),r=this.ffi.QTS_ExecutePendingJob(this.rt.value,e??-1,t.value.ptr),i=t.value.typedArray[0];if(t.dispose(),0===i)return this.ffi.QTS_FreeValuePointerRuntime(this.rt.value,r),k.success(0);let s=this.contextMap.get(i)??this.newContext({contextPointer:i}),n=s.getMemory(this.rt.value).heapValueHandle(r);if("number"===s.typeof(n)){let e=s.getNumber(n);return n.dispose(),k.success(e)}{let e=Object.assign(n,{context:s});return k.fail(e,e=>s.unwrapResult(e))}}setMemoryLimit(e){if(e<0&&-1!==e)throw Error("Cannot set memory limit to negative number. To unset, pass -1");this.ffi.QTS_RuntimeSetMemoryLimit(this.rt.value,e)}computeMemoryUsage(){let e=this.getSystemContext().getMemory(this.rt.value);return e.heapValueHandle(this.ffi.QTS_RuntimeComputeMemoryUsage(this.rt.value,e.ctx.value))}dumpMemoryUsage(){return this.memory.consumeHeapCharPointer(this.ffi.QTS_RuntimeDumpMemoryUsage(this.rt.value))}setMaxStackSize(e){if(e<0)throw Error("Cannot set memory limit to negative number. To unset, pass 0.");this.ffi.QTS_RuntimeSetMaxStackSize(this.rt.value,e)}assertOwned(e){if(e.owner&&e.owner.rt!==this.rt)throw new a(`Handle is not owned by this runtime: ${e.owner.rt.value} != ${this.rt.value}`)}setDebugMode(e){this._debugMode=e,this.ffi.DEBUG&&this.rt.alive&&this.ffi.QTS_SetDebugLogEnabled(this.rt.value,+!!e)}isDebugMode(){return this._debugMode}debugLog(...e){this._debugMode&&console.log("quickjs-emscripten:",...e)}[Symbol.for("nodejs.util.inspect.custom")](){return this.alive?`${this.constructor.name} { rt: ${this.rt.value} }`:`${this.constructor.name} { disposed }`}getSystemContext(){return this.context||(this.context=this.scope.manage(this.newContext())),this.context}},F=class{constructor(e){this.callFunction=e.callFunction,this.shouldInterrupt=e.shouldInterrupt,this.loadModuleSource=e.loadModuleSource,this.normalizeModule=e.normalizeModule}},B=class{constructor(e){this.contextCallbacks=new Map,this.runtimeCallbacks=new Map,this.suspendedCount=0,this.cToHostCallbacks=new F({callFunction:(e,t,r,i,s,n)=>this.handleAsyncify(e,()=>{try{let e=this.contextCallbacks.get(t);if(!e)throw Error(`QuickJSContext(ctx = ${t}) not found for C function call "${n}"`);return e.callFunction(t,r,i,s,n)}catch(e){return console.error("[C to host error: returning null]",e),0}}),shouldInterrupt:(e,t)=>this.handleAsyncify(e,()=>{try{let e=this.runtimeCallbacks.get(t);if(!e)throw Error(`QuickJSRuntime(rt = ${t}) not found for C interrupt`);return e.shouldInterrupt(t)}catch(e){return console.error("[C to host interrupt: returning error]",e),1}}),loadModuleSource:(e,t,r,i)=>this.handleAsyncify(e,()=>{try{let e=this.runtimeCallbacks.get(t);if(!e)throw Error(`QuickJSRuntime(rt = ${t}) not found for C module loader`);let s=e.loadModuleSource;if(!s)throw Error(`QuickJSRuntime(rt = ${t}) does not support module loading`);return s(t,r,i)}catch(e){return console.error("[C to host module loader error: returning null]",e),0}}),normalizeModule:(e,t,r,i,s)=>this.handleAsyncify(e,()=>{try{let e=this.runtimeCallbacks.get(t);if(!e)throw Error(`QuickJSRuntime(rt = ${t}) not found for C module loader`);let n=e.normalizeModule;if(!n)throw Error(`QuickJSRuntime(rt = ${t}) does not support module loading`);return n(t,r,i,s)}catch(e){return console.error("[C to host module loader error: returning null]",e),0}})}),this.module=e,this.module.callbacks=this.cToHostCallbacks}setRuntimeCallbacks(e,t){this.runtimeCallbacks.set(e,t)}deleteRuntime(e){this.runtimeCallbacks.delete(e)}setContextCallbacks(e,t){this.contextCallbacks.set(e,t)}deleteContext(e){this.contextCallbacks.delete(e)}handleAsyncify(e,t){if(e)return e.handleSleep(e=>{try{let r=t();if(!(r instanceof Promise)){n("asyncify.handleSleep: not suspending:",r),e(r);return}if(this.suspended)throw new h(`Already suspended at: ${this.suspended.stack}
Attempted to suspend at:`);this.suspended=new c(`(${this.suspendedCount++})`),n("asyncify.handleSleep: suspending:",this.suspended),r.then(t=>{this.suspended=void 0,n("asyncify.handleSleep: resolved:",t),e(t)},e=>{n("asyncify.handleSleep: rejected:",e),console.error("QuickJS: cannot handle error in suspended function",e),this.suspended=void 0})}catch(e){throw n("asyncify.handleSleep: error:",e),this.suspended=void 0,e}});let r=t();if(r instanceof Promise)throw Error("Promise return value not supported in non-asyncify context.");return r}};function j(e,t){t.interruptHandler&&e.setInterruptHandler(t.interruptHandler),void 0!==t.maxStackSizeBytes&&e.setMaxStackSize(t.maxStackSizeBytes),void 0!==t.memoryLimitBytes&&e.setMemoryLimit(t.memoryLimitBytes)}function G(e,t){t.moduleLoader&&e.setModuleLoader(t.moduleLoader),t.shouldInterrupt&&e.setInterruptHandler(t.shouldInterrupt),void 0!==t.memoryLimitBytes&&e.setMemoryLimit(t.memoryLimitBytes),void 0!==t.maxStackSizeBytes&&e.setMaxStackSize(t.maxStackSizeBytes)}var U=class{constructor(e,t){this.module=e,this.ffi=t,this.callbacks=new B(e)}newRuntime(e={}){let t=new x(this.ffi.QTS_NewRuntime(),void 0,e=>{this.callbacks.deleteRuntime(e),this.ffi.QTS_FreeRuntime(e)}),r=new R({module:this.module,callbacks:this.callbacks,ffi:this.ffi,rt:t});return j(r,e),e.moduleLoader&&r.setModuleLoader(e.moduleLoader),r}newContext(e={}){let t=this.newRuntime(),r=t.newContext({...e,ownedLifetimes:function(...e){let t=[];for(let r of e)void 0!==r&&(t=t.concat(r));return t}(t,e.ownedLifetimes)});return t.context=r,r}evalCode(e,t={}){return Q.withScope(r=>{let i=r.manage(this.newContext());G(i.runtime,t);let s=i.evalCode(e,"eval.js");if(void 0!==t.memoryLimitBytes&&i.runtime.setMemoryLimit(-1),s.error)throw i.dump(r.manage(s.error));return i.dump(r.manage(s.value))})}getWasmMemory(){let e=this.module.quickjsEmscriptenInit?.(()=>{})?.getWasmMemory?.();if(!e)throw Error("Variant does not support getting WebAssembly.Memory");return e}getFFI(){return this.ffi}}}}]);